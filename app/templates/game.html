{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title text-center">Uncrypt Game</h2>

                <!-- API Documentation -->
                <div class="mb-4">
                    <h4>API Endpoints</h4>
                    <div class="card mb-3">
                        <div class="card-header">
                            Guess Endpoint - POST /guess
                        </div>
                        <div class="card-body">
                            <pre class="bg-dark text-light p-3 rounded"><code>{{ sample_guess_json | tojson(indent=2) }}</code></pre>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            Hint Endpoint - POST /hint
                        </div>
                        <div class="card-body">
                            <pre class="bg-dark text-light p-3 rounded"><code>{{ sample_hint_json | tojson(indent=2) }}</code></pre>
                        </div>
                    </div>
                </div>

                <!-- Game Controls -->
                <div class="text-center mb-4">
                    <button id="startGame" class="btn btn-primary">Start New Game</button>
                    <button id="getHint" class="btn btn-secondary ms-2" disabled>Get Hint</button>
                </div>

                <div id="gameArea" class="d-none">
                    <div class="alert alert-info">
                        <h5>Encrypted Quote:</h5>
                        <p id="encryptedQuote" class="font-monospace"></p>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    Encrypted Letters
                                </div>
                                <div class="card-body">
                                    <div id="encryptedGrid" class="d-flex flex-wrap gap-2">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    Available Letters
                                </div>
                                <div class="card-body">
                                    <div id="letterGrid" class="d-flex flex-wrap gap-2">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <span>Mistakes remaining: </span>
                        <span id="mistakesCount">5</span>
                    </div>

                    <div id="guessArea" class="mb-3 d-none">
                        <p>Selected encrypted letter: <span id="selectedEncrypted" class="badge bg-primary"></span></p>
                        <p>Choose a letter from the available letters grid</p>
                    </div>

                    <div id="revealedPairs" class="mt-3">
                        <h5>Revealed Letter Pairs:</h5>
                        <div id="pairsList" class="d-flex flex-wrap gap-2">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Check authentication on page load
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('access_token');
    console.log('Token on page load:', token ? 'Present' : 'Missing');

    if (!token) {
        console.log('No token found, redirecting to login');
        window.location.href = '/';
        return;
    }
});

// Helper function for authenticated API calls
async function authenticatedFetch(url, options = {}) {
    const token = localStorage.getItem('access_token');
    console.log('Making authenticated request to:', url);

    if (!token) {
        console.log('No token available for request');
        window.location.href = '/';
        return;
    }

    const defaultOptions = {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    };

    const finalOptions = { 
        ...defaultOptions,
        ...options,
        headers: {
            ...defaultOptions.headers,
            ...(options.headers || {})
        }
    };

    try {
        console.log('Request headers:', finalOptions.headers);
        const response = await fetch(url, finalOptions);

        if (response.status === 401) {
            console.log('Unauthorized response received');
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/';
            return;
        }
        return response;
    } catch (error) {
        console.error('API Error:', error);
        alert('An error occurred. Please try again.');
    }
}

function createLetterButton(letter, type) {
    const btn = document.createElement('button');
    btn.className = 'btn btn-outline-primary';
    btn.textContent = letter;

    if (type === 'encrypted') {
        btn.onclick = () => selectEncryptedLetter(letter);
    } else {
        btn.onclick = () => makeGuess(letter);
    }

    return btn;
}

function selectEncryptedLetter(letter) {
    selectedEncryptedLetter = letter;
    document.getElementById('selectedEncrypted').textContent = letter;
    document.getElementById('guessArea').classList.remove('d-none');
}

async function makeGuess(guessedLetter) {
    if (!selectedEncryptedLetter) {
        alert('Please select an encrypted letter first');
        return;
    }

    try {
        const response = await authenticatedFetch('/guess', {
            method: 'POST',
            body: JSON.stringify({
                encrypted_letter: selectedEncryptedLetter,
                guessed_letter: guessedLetter
            })
        });

        if (response && response.ok) {
            const data = await response.json();
            document.getElementById('mistakesCount').textContent = 5 - data.mistakes;
            document.getElementById('encryptedQuote').textContent = data.display;

            if (data.game_complete) {
                alert(data.mistakes >= 5 ? 
                    'Game Over! Too many mistakes.' : 
                    'Congratulations! You\'ve decrypted the quote!');
                document.getElementById('getHint').disabled = true;
            }

            selectedEncryptedLetter = null;
            document.getElementById('guessArea').classList.add('d-none');
        }
    } catch (error) {
        console.error('Error submitting guess:', error);
    }
}

// Game event listeners
document.getElementById('startGame').addEventListener('click', async () => {
    try {
        const response = await authenticatedFetch('/start', {
            method: 'GET'
        });

        if (response && response.ok) {
            const data = await response.json();
            document.getElementById('gameArea').classList.remove('d-none');
            document.getElementById('encryptedQuote').textContent = data.encrypted_paragraph;

            // Set up letter grids
            const encryptedGrid = document.getElementById('encryptedGrid');
            const letterGrid = document.getElementById('letterGrid');
            encryptedGrid.innerHTML = '';
            letterGrid.innerHTML = '';

            // Add frequency information to encrypted letters
            Object.entries(data.letter_frequency).forEach(([letter, freq]) => {
                const btn = createLetterButton(letter, 'encrypted');
                encryptedGrid.appendChild(btn);
            });

            // Add available letters for guessing
            data.original_letters.forEach(letter => {
                const btn = createLetterButton(letter, 'guess');
                letterGrid.appendChild(btn);
            });

            document.getElementById('getHint').disabled = false;
            document.getElementById('mistakesCount').textContent = '5';
            document.getElementById('pairsList').innerHTML = '';
        }
    } catch (error) {
        console.error('Error starting game:', error);
    }
});

document.getElementById('getHint').addEventListener('click', async () => {
    try {
        const response = await authenticatedFetch('/hint', {
            method: 'POST'
        });
        if (response && response.ok) {
            const data = await response.json();
            document.getElementById('encryptedQuote').textContent = data.display;
            document.getElementById('mistakesCount').textContent = 5 - data.mistakes;
        }
    } catch (error) {
        console.error('Error getting hint:', error);
    }
});
</script>
{% endblock %}