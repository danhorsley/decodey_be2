{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title text-center">Uncrypt Game</h2>
                <div class="text-center mb-4">
                    <button id="startGame" class="btn btn-primary">Start New Game</button>
                    <button id="getHint" class="btn btn-secondary ms-2" disabled>Get Hint</button>
                </div>

                <div id="gameArea" class="d-none">
                    <div class="alert alert-info">
                        <h5>Encrypted Quote:</h5>
                        <p id="encryptedQuote" class="font-monospace"></p>
                    </div>

                    <div class="mb-3">
                        <label for="guess" class="form-label">Enter your guess:</label>
                        <input type="text" class="form-control" id="guess">
                        <div class="form-text">Try to guess the original quote. Capitalization doesn't matter.</div>
                    </div>
                    <button id="submitGuess" class="btn btn-success">Submit Guess</button>

                    <div id="feedback" class="mt-3">
                        <h5>Previous Guesses:</h5>
                        <ul id="guessList" class="list-group">
                        </ul>
                    </div>

                    <div id="hints" class="mt-3">
                        <h5>Hints:</h5>
                        <ul id="hintList" class="list-group">
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Check authentication on page load
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('access_token');
    console.log('Token on page load:', token ? 'Present' : 'Missing');

    if (!token) {
        console.log('No token found, redirecting to login');
        window.location.href = '/';
        return;
    }
});

// Helper function for authenticated API calls
async function authenticatedFetch(url, options = {}) {
    const token = localStorage.getItem('access_token');
    console.log('Making authenticated request to:', url);

    if (!token) {
        console.log('No token available for request');
        window.location.href = '/';
        return;
    }

    const defaultOptions = {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    };

    const finalOptions = { 
        ...defaultOptions,
        ...options,
        headers: {
            ...defaultOptions.headers,
            ...(options.headers || {})
        }
    };

    try {
        console.log('Request headers:', finalOptions.headers);
        const response = await fetch(url, finalOptions);

        if (response.status === 401) {
            console.log('Unauthorized response received');
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/';
            return;
        }
        return response;
    } catch (error) {
        console.error('API Error:', error);
        alert('An error occurred. Please try again.');
    }
}

// Game event listeners
document.getElementById('startGame').addEventListener('click', async () => {
    try {
        const response = await authenticatedFetch('/api/game/start', { method: 'POST' });
        if (response && response.ok) {
            const data = await response.json();
            document.getElementById('gameArea').classList.remove('d-none');
            document.getElementById('guessList').innerHTML = '';
            document.getElementById('hintList').innerHTML = '';
            document.getElementById('encryptedQuote').textContent = data.encrypted_quote;
            document.getElementById('getHint').disabled = false;
        }
    } catch (error) {
        console.error('Error starting game:', error);
    }
});

document.getElementById('submitGuess').addEventListener('click', async () => {
    const guess = document.getElementById('guess').value;
    if (!guess) return;

    try {
        const response = await authenticatedFetch('/api/game/guess', {
            method: 'POST',
            body: JSON.stringify({ guess })
        });

        if (response && response.ok) {
            const data = await response.json();
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item';
            listItem.textContent = `${guess} - Matches at positions: ${data.matching_positions.join(', ')}`;
            document.getElementById('guessList').prepend(listItem);
            document.getElementById('guess').value = '';

            if (data.correct) {
                alert('Congratulations! You decrypted the quote correctly!');
                document.getElementById('getHint').disabled = true;
                document.getElementById('submitGuess').disabled = true;
            }
        }
    } catch (error) {
        console.error('Error submitting guess:', error);
    }
});

document.getElementById('getHint').addEventListener('click', async () => {
    try {
        const response = await authenticatedFetch('/api/game/hint');
        if (response && response.ok) {
            const data = await response.json();
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item';
            listItem.textContent = data.hint;
            document.getElementById('hintList').prepend(listItem);
        }
    } catch (error) {
        console.error('Error getting hint:', error);
    }
});
</script>
{% endblock %}